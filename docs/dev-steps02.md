# 次フェーズ 開発手順（dev-steps02）

このドキュメントは、`firebase-sticky-board` の MVP 完了後に、  
次の段階へ進むための作業手順メモです。

このフェーズでは、MVP を壊さずに機能を拡張し、  
匿名ユーザーによる共同編集と  
非匿名ログイン（オーナー）によるボード作成を両立させます。

## 次フェーズのゴール

このフェーズの到達点は以下です。

- 付箋を削除できる
- 付箋の色を変更できる
- 匿名認証を導入し、匿名ユーザーとしてボードに参加できる
- 非匿名ログイン（Google 等）でのみボードを作成できる
- 共有リンク方式（boardId を URL に含める）で共同編集できる
- Firestore security rules により、最低限の権限制御ができる
- Firebase Hosting で公開され、共有可能な状態になっている

## 基本方針（重要）

- ボード作成者（オーナー）は非匿名ログイン必須
- ボード参加者は匿名ログインで可
- 共有は「リンクを知っている人は編集できる」前提とする
- 招待管理（メンバー一覧、権限管理 UI）は実装しない
- テキスト編集の同時編集や CRDT は扱わない
- 既存の MVP 構造をできるだけ壊さない

## 役割の整理

### オーナー（Owner）
- 非匿名ログイン（Google ログインなど）
- ボードを作成できる
- ボード情報（設定・削除など）の管理主体

### 参加者（Participant）
- 匿名ログイン
- 共有リンク経由でボードに参加
- 付箋の追加・移動・削除・色変更が可能

## 推奨する進め方（順番）

1. 付箋削除
2. 付箋色変更
3. 認証基盤の準備（匿名＋非匿名）
4. ボード作成フロー（非匿名ログイン必須）
5. 共有リンク方式（boardId を URL に含める）
6. Firestore security rules
7. UI 微調整（必要最小限）

## データ設計（次フェーズ）

### ボード

```
boards/{boardId}

* createdAt
* ownerUid        // 非匿名ログインユーザーの uid
* visibility: "public-link"
```

- boardId はランダム ID
- board 作成はオーナーのみ可能

### 付箋

```
boards/{boardId}/notes/{noteId}

* text: string
* x: number
* y: number
* color: string
* createdAt
* updatedAt
* createdBy        // 匿名含む uid
```

既存データに `color` が無い場合は、表示側でデフォルト色を適用する。

## 開発手順

### 1. 付箋削除

目的：
- delete 操作を追加し、共同編集でも正しく同期されるようにする

実装：
- 付箋 UI に削除ボタンを追加
- `deleteDoc()` を使用
- state 操作は行わず、`onSnapshot()` による再描画に任せる

完了条件：
- 付箋を削除できる
- 別ブラウザでも削除が同期される

### 2. 付箋の色変更

目的：
- note 属性追加と UI 表現拡張

実装：
- `color` フィールドを追加
- 色変更時に `updateDoc()` で更新
- 表示は CSS 切り替えで対応

完了条件：
- 色が即時反映される
- 共同編集でも破綻しない

### 3. 認証基盤の準備（匿名＋非匿名）

目的：
- オーナーと参加者を区別できる状態を作る

準備：
- Firebase Console で Authentication を有効化
- 以下の Sign-in method を有効にする
  - Anonymous
  - Google（または他 1 種類）

実装方針：
- アプリ起動時：
  - 原則として匿名ログインを行う
- ボード作成時：
  - 非匿名ログインであることを要求する
  - 未ログインの場合は Google ログインを促す

完了条件：
- 匿名ユーザーとして uid が取得できる
- Google ログインユーザーとして uid が取得できる

### 4. ボード作成フロー（オーナーは非匿名ログイン必須）

目的：
- ボードの「持ち主」を明確にする

仕様：
- トップ画面（`/`）に「ボードを作成」ボタンを用意
- ボタン押下時：
  - 非匿名ログインでなければログインを要求
  - ログイン後に board を作成
- 作成後、`/b/:boardId` に遷移

実装：
- `boards` コレクションに `addDoc()`
- `ownerUid` に `auth.currentUser.uid` を保存

完了条件：
- 非匿名ログインユーザーのみボードを作成できる
- 作成者が ownerUid として保存される

### 5. 共有リンク方式（boardId を URL に含める）

目的：
- 同じ URL を開けば同じボードを共同編集できる状態を作る

仕様：
- ルーティング：`/b/:boardId`
- 共有リンクはこの URL をそのまま渡す
- board が存在しない場合はエラー表示（自動作成は行わない）

実装：
- React Router を導入
- URL から boardId を取得
- `boards/{boardId}/notes` を購読

完了条件：
- 同じ URL を複数ブラウザで開くと同じボードが表示される
- 匿名ユーザーでも編集できる

### 6. Firestore security rules（最低限）

目的：
- オーナーと参加者の役割をルールで保証する

最初のルール例：
- read: 全員許可
- write（notes）: 認証ユーザー（匿名含む）のみ許可
- write（boards）: 非匿名ログインユーザーのみ許可
- update / delete（boards）: ownerUid のみ許可

注意：
- rules は段階的に強化する
- 最初から厳密にしすぎない

完了条件：
- 未認証ユーザーの書き込みが拒否される
- オーナー以外が board を変更できない

### 7. UI 微調整（必要最小限）

対象：
- ボード作成導線
- 共有リンクのコピー UI
- 付箋操作（削除・色変更）の視認性

完了条件：
- 使い方が直感的
- 機能が増えても UI が破綻していない

## デプロイ

- Hosting と Rules を適宜デプロイする

例：
```bash
firebase deploy --only hosting
firebase deploy --only firestore:rules
```

## 想定作業時間（目安）

- [x] 付箋削除：30〜60分
- [x] 色変更：30〜90分
- [] 認証基盤準備：60〜120分
- [] ボード作成フロー：60〜120分
- [] 共有リンク対応：60〜180分
- [] Rules 導入：60〜180分
- [] UI 微調整：30〜120分

合計：おおむね 1〜2 週間（朝 30〜60 分ペース）

## スコープ外（このフェーズでは扱わない）

- 招待管理 UI
- メンバー権限ロール
- テキストの同時編集
- Undo / Redo
- 監査ログ・履歴

## 補足（設計上の意図）

「オーナー作成は非匿名」「参加は匿名」という構成により、
- 体験は軽く
- 責任の所在は明確に

できる設計とする。

本格的な権限管理は、次フェーズ以降に回す

## （将来補足）より一般的な運用に寄せるための拡張方針

現状の共有リンク方式は「リンクを知っている人は編集できる」前提であり、MVP〜小規模用途では扱いやすい一方、公開範囲が広がるほどリスク（意図しない編集・荒らし等）が増えます。

次に「より一般的」な運用に寄せるなら、以下の順で段階的に強化するのが自然です。

1. Firestore security rules で「非匿名ログインのみボード作成」を必ず保証する
    - UI 側で弾くだけではなく、Rules 側でも create を拒否できる状態にする
2. 共有の強度を必要に応じて上げる
    - トークン方式（URL にランダムな editToken を含める / ボードに紐付ける）
    - 招待方式（メンバーコレクション、権限ロール、招待 UI）
3. 速度制限や簡単なスパム対策（Cloud Functions等）
    - Rulesで入力検証 + 更新フィールド制限 + 上限（付箋数など）
    - App Check を有効化（WebならreCAPTCHA系）
    - それでも必要なら、ボード作成（＋付箋作成）をFunctionsに寄せる

最初から強い共有モデル（招待・権限管理）を作り込むのではなく、必要になったタイミングで「共有の強度」を上げていく設計とする。

## （補足）将来のリファクタリング方針

- 現状は「シングルファイルで完結・シンプルさ優先」。
- 以下の状態になったら、機能ごとに分割するリファクタリングを検討する：
  - 付箋（Note）の属性やUIが増えた時
  - 付箋追加フォームのロジックやデザインが複雑になる時
  - ボード系の状態管理・表示が肥大化する時
- 分割例：`<StickyNote />`コンポーネント、`NoteInput`フォーム、ドラッグ操作用のカスタムフックなど

※ ただし、過度な抽象化は避けること。

## 補足メモ（今後の課題・検討）

- Top画面のユーザー状態管理は、`auth.currentUser` への直接アクセスではなく、`onAuthStateChanged` を利用して state でユーザーを管理する方式に将来的に見直すとよい。  
  - 理由：画面初期化時や認証フローの非同期切り替えに強くなるため。
- ログアウト機能については、現状のフロー・要件では未実装だが、必要に応じて`signOut(auth)`で対応可能。  
- ルーティング対応、ボード作成フローの動作確認後に検討
